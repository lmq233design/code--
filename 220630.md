# JS代码浏览器优化流程

### chrome和node的引擎都采用的是V8引擎，那么什么是V8引擎？
V8是一个接受JS代码，编译代码然后执行的C++程序。帮助JS代码在多种操作系统上运行。
V8主要负责编译执行JS代码，处理调用栈，内存分配，垃圾回收。

V8组成结构：
- 解析器
- 解释器
- 编译器

> 早期V8解析器生成语法树，然后编译器1生成未被优化的机器代码，然后运行一段时间后，编译器2生成优化后的机器代码；机器码内存占有量过大，优化困难，只执行一次的代码也会生成大量的机器码，对于新JS规范无法适应

- 解析器生成AST
- 解释器生成字节码，此时AST被清除，在运行中，这时候优化编译器会在字节码模块直接优化，字节码因为比机器代码高级，相对的代码占有容量简介程度也小很多；
- 编译器生成机器代码，但此时的机器代码也不是固定，因为JS本质上是一门动态语言，机器代码有可能deoptimization到字节码，例如中途变换代码的的参数类型，因为JS的数据类型只有VAR、LET一个大类；与此同时因为机器代码在重新优化的过程中，仅仅退回到字节码模块，而不需要像早期的V8代码一样整体源代码重新编译，所以性能得到更大的提升。

---

### 浏览器是如何运作的？
浏览器进程，GPU进程，插件进程，缓存进程，网络进程，渲染器进程。

#### 一个页面JS没有及时归还主线程，会影响其他页面的加载吗？
> 因为chrome浏览器默认采用的浏览页面进程管理策略，所以每个页面的浏览器渲染进程都是单独隔离。

地址栏输入网址，浏览器进程UI捕捉，送给网络线程请求DNS进行域名解析，接着开始链接服务器获取数据。
之后：
1. 网络进程获取数据后通过safebrowsing检查站点是否是恶意站点，如通过查看IP是否在黑名单内；
2. 网络进程发送消息给UI进程，UI进程创建渲染器进程渲染页面；
3. 渲染器进程获得HTML，解析，构造DOM文档对象模型，进行DOM数构造，创建根document和节点；
4. 构造DOM的过程中遇到JS程序，将会停止DOM树构造优先加载JS进程，因为JS会修改DOM结构；
5. 主线程解析CSS去顶各个节点的样式，坐标，确定LAYOUT布局;
6. z-index会影响层级，所以会创建一个块表，里面放置了文档节点的层级以及绘制顺序；
7. 最后进行栅格化；切分图块，然后放在内存中，最后用合成器线程进行合成，形成合成器帧；
8. 传给GPU，进行渲染在页面上。

在tips4中JS会参与到流程，但是如果整个JS进行运行的话，那么JS会抢占主线程，JS一旦没有及时归还主线程，则会导致下一帧的卡顿，所以可以将JS流程切分成小块，插分到整个渲染器进程中，比如REACT 就采用这一技术进行优化。



